credits: [darimachine](https://github.com/darimachine)

#  –£–º–Ω–∏ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ C++

–£–º–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª –µ –æ–±–≤–∏–≤–∞—â –∫–ª–∞—Å –∑–∞ –æ–±–∏–∫–Ω–æ–≤–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª, –∫–æ–π—Ç–æ **–º–µ–Ω–∞–∂–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–∞–º–µ—Ç—Ç–∞** –Ω–∞ –æ–±–µ–∫—Ç–∞, –∫—ä–º –∫–æ–π—Ç–æ —Å–æ—á–∏.

**–¶–µ–ª:** –î–∞ –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ `new` –∏ `delete`, —Å —Ü–µ–ª –¥–∞ –Ω–µ –ø—Ä–æ–ø—É—Å–Ω–µ–º –¥–∞ –∏–∑—Ç—Ä–∏–µ–º –¥–∞–¥–µ–Ω —Ä–µ—Å—É—Ä—Å.

–ü—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ —Å `new`, —É–º–Ω–∏—è—Ç —É–∫–∞–∑–∞—Ç–µ–ª –ø–æ–µ–º–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç—Ç–∞ –Ω–∞–¥ –æ–±–µ–∫—Ç–∞. –ü—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–≤–∏–∫–≤–∞ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –º—É.

---

## 1.  `auto_ptr` ‚Äì deprecated (–æ—Å—Ç–∞—Ä—è–ª)

> –ù–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –≤ modern C++, –∑–∞–ø–∞–∑–µ–Ω —Å–∞–º–æ –∑–∞ –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Å—Ç–∞—Ä –∫–æ–¥.

### –ü—Ä–∏–º–µ—Ä:
```cpp
#include <memory>
auto_ptr<A> ptr(new A());
```
## 2.  `unique_ptr` ‚Äì —Ç–æ—á–Ω–æ –µ–¥–∏–Ω —É–∫–∞–∑–∞—Ç–µ–ª –∑–∞ —Ç–æ—á–Ω–æ –µ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å

`unique_ptr` –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ **—Å–∞–º–æ –µ–¥–∏–Ω —É–∫–∞–∑–∞—Ç–µ–ª –ø—Ä–∏—Ç–µ–∂–∞–≤–∞ –¥–∞–¥–µ–Ω —Ä–µ—Å—É—Ä—Å**.  
–ù–µ –ø–æ–∑–≤–æ–ª—è–≤–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ ‚Äì —Å–∞–º–æ **–ø—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç** —á—Ä–µ–∑ `std::move`.

---

###  –û—Å–Ω–æ–≤–Ω–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞ —Ä–µ—Å—É—Ä—Å –ø—Ä–∏ –∏–∑–ª–∏–∑–∞–Ω–µ –æ—Ç –æ–±—Ö–≤–∞—Ç
- **–ù—è–º–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ** (`copy constructor` –∏ `operator=` —Å–∞ –∏–∑—Ç—Ä–∏—Ç–∏)
- –ò–º–∞ **move —Å–µ–º–∞–Ω—Ç–∏–∫–∞**
- –ò–¥–µ–∞–ª–µ–Ω –∑–∞ —Å–ª—É—á–∞–∏—Ç–µ, –∫–æ–≥–∞—Ç–æ —Ä–µ—Å—É—Ä—Å —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ **—Å–∞–º–æ –Ω–∞ –µ–¥–Ω–æ –º—è—Å—Ç–æ**

---

![Unique_Ptr](Unique_Ptr.png)

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Å `make_unique`

```cpp
#include <iostream>
class A {
public:
    A(int a, bool b) { /*...*/ }
    ~A() { /*...*/ }
};

int main() {
    std::unique_ptr<A> up = std::make_unique<A>(2, true);
    // –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–≤–∏–∫–≤–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ A(2, true)
} // –ü—Ä–∏ –∏–∑—Ö–æ–¥ –æ—Ç main() —Å–µ –∏–∑–≤–∏–∫–≤–∞ ~A()
```
```c++
make_unique<T>(....) - —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –≤–º–µ—Å—Ç–æ new
```

###  –ó–∞—â–æ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `make_unique` –≤–º–µ—Å—Ç–æ `new`?
 - –ò–∑–±—è–≥–≤–∞ memory leak –ø—Ä–∏ –∏–∑–∫–ª—é—á–µ–Ω–∏—è
```c++
std::unique_ptr<A> up(new A(2, true));
// –∞–∫–æ –º–µ–∂–¥—É new –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ä–∑–Ω–∏–∫–Ω–µ –∏–∑–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –ø–∞–º–µ—Ç—Ç–∞ –Ω–µ —Å–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞
```

`make_unique<A>(...)` –ø—Ä–∞–≤–∏ –≤—Å–∏—á–∫–æ –≤ –µ–¥–Ω–∞ —Å—Ç—ä–ø–∫–∞, —Ç–∞–∫–∞ —á–µ –∞–∫–æ –Ω–µ—â–æ —Å–µ –æ–±—ä—Ä–∫–∞ ‚Äî –Ω—è–º–∞ —Ç–µ—á –Ω–∞ –ø–∞–º–µ—Ç.

- –§—É–Ω–∫—Ü–∏—è—Ç–∞ `make_unique<T>(–ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞ –∫–æ–Ω—Å—Ç—É–∫—Ç–æ—Ä–∞)` - —à–∞–±–ª–æ–Ω–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—è—Ç–æ –ø—Ä–∏–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—Ç–µ, –Ω—É–∂–Ω–∏ –∑–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ `T`, –∏–∑–≤–∏–∫–∞ –≤—ä—Ç—Ä–µ—à–Ω–æ `new` –∏ –≤—Ä—ä—â–∞ unique_ptr –∫—ä–º –æ–±–µ–∫—Ç–∞.
  
- –ó–∞–±—Ä–∞–Ω–µ–Ω–∏ —Å–∞ `–ö–æ–ø–∏—Ä–∞—â –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä` –∏ `–æ–ø=`, –∑–∞—â–æ—Ç–æ –∏—Å–∫–∞–º–µ –¥–∞ –µ –µ–¥–∏–Ω, —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ move —Å–µ–º–∞–Ω—Ç–∏–∫–∞
##### –ó–∞–±—Ä–∞–Ω–µ–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ

```cpp
std::unique_ptr<A> up1 = std::make_unique<A>(2, true);
std::unique_ptr<A> up2 = up1;              // ‚ùå –ì—Ä–µ—à–∫–∞: –∑–∞–±—Ä–∞–Ω–µ–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ
std::unique_ptr<A> up3 = std::move(up1);   // ‚úÖ –ü—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç
```
  
- –©–µ —Å–µ —Å—á—É–ø–∏, –∞–∫–æ –∫—ä–º –∫—ä–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª–Ω–æ —Å—ä–∑–¥–∞–¥–µ–Ω –æ–±–µ–∫—Ç –Ω–∞—Å–æ—á–∏–º–µ –¥–≤–∞ `unique_ptr`. –ù–∏—Ç–æ –µ–¥–∏–Ω –æ—Ç —Ç—è—Ö –Ω–µ –ø–æ–¥–æ–∑–∏—Ä–∞ –∑–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞–Ω–µ—Ç–æ –Ω–∞ –¥—Ä—É–≥–∏—è —Ç–æ–µ—Å—Ç –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ –µ–¥–∏–Ω–∏—è –ø–∞–º–µ—Ç—Ç–∞ —â–µ —Å–µ –∏–∑—Ç—Ä–∏–µ –∏ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä—ä—Ç –Ω–∞ –≤—Ç–æ—Ä–∏—è —â–µ –≥—Ä—ä–º–Ω–µ.
##### –î–≤–∞ `unique_ptr` –∫—ä–º –µ–¥–∏–Ω –∏ —Å—ä—â–∏ –æ–±–µ–∫—Ç

```c++
#include <iostream>
using namespace std;
class A {
};
int main()
{
    A* a = new A();
    unique_ptr<A> up1(a);
    unique_ptr<A> up2(a);
} -> —â–µ –≥—Ä—ä–º–Ω–µ, –∑–∞—â–æ—Ç–æ —Å–µ –æ–ø–∏—Ç–≤–∞ –¥–∞ –∏–∑—Ç—Ä–∏–µ –ø—Ä–∞–∑–Ω–∏ –¥–∞–Ω–Ω–∏(–≤–µ—á–µ –µ –±–∏–ª –∏–∑—Ç—Ä–∏—Ç –æ—Ç up2 –∏ up1 –≥—ä—Ä–º–∏).
```

#####  –ì—Ä–µ—à–µ–Ω –ø—Ä–∏–º–µ—Ä —Å `make_unique`

```c++
class A{

}
int main() {
    A* a = new A();
    unique_ptr<A> up1=make_unique<A>(–∞); // –¢–æ–≤–∞ —â–µ –¥–∞–¥–µ –≥—Ä–µ—à–∫–∞ –∑–∞—â–æ—Ç–æ —Ç—ä—Ä—Å–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä A(A*)
    unique_ptr<A> up2=make_unique<A>(–∞); // —Å—ä—à–æ—Ç–æ
} 
```
`make_unique<A>(a)` —Å–µ –æ–ø–∏—Ç–≤–∞ –¥–∞ –∏–∑–≤–∏–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `A(A*)`, –∫–æ–π—Ç–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ ‚Üí –∫–æ–º–ø–∏–ª–∞—Ü–∏–æ–Ω–Ω–∞ –≥—Ä–µ—à–∫–∞.

---

## 3. `shared_ptr` ‚Äì 1 –æ–±–µ–∫—Ç, –Ω–æ –º–Ω–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª–∏ (—Å–ø–æ–¥–µ–ª–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç)

–¥–µ—Ñ: –ö–ª–∞—Å, –∫–æ–π—Ç–æ –ø–∞–∑–∏ —É–∫–∞–∑–∞—Ç–µ–ª –∫—ä–º –æ–±–µ–∫—Ç –∏ –±—Ä–æ—è—á –∫–æ–ª–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–∞ –Ω–∞—Å–æ—á–µ–Ω–∏ –∫—ä–º –æ–±–µ–∫—Ç–∞.

`shared_ptr` –µ —É–º–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª, –∫–æ–π—Ç–æ –ø–æ–∑–≤–æ–ª—è–≤–∞ **–º–Ω–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –∫—ä–º –µ–¥–∏–Ω –∏ —Å—ä—â –æ–±–µ–∫—Ç**.  
–í—Å–µ–∫–∏ `shared_ptr` —É–≤–µ–ª–∏—á–∞–≤–∞ –≤—ä—Ç—Ä–µ—à–Ω–∏—è **—Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–µ–Ω –±—Ä–æ—è—á**, –∏ –∫–æ–≥–∞—Ç–æ —Ç–æ–π –¥–æ—Å—Ç–∏–≥–Ω–µ 0 ‚Äì –æ–±–µ–∫—Ç—ä—Ç —Å–µ –∏–∑—Ç—Ä–∏–≤–∞.

---

###  –û—Å–Ω–æ–≤–Ω–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- –û–±–µ–∫—Ç—ä—Ç —Å–µ —Å—ä–∑–¥–∞–≤–∞ –ø—Ä–∏ –ø—ä—Ä–≤–∏—è `shared_ptr`
- –ù–æ–≤–∏—Ç–µ `shared_ptr` –∫–æ–ø–∏—Ä–∞—Ç (shallow) –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ —É–≤–µ–ª–∏—á–∞–≤–∞—Ç –±—Ä–æ—è—á–∞
- –û–±–µ–∫—Ç—ä—Ç —Å–µ –∏–∑—Ç—Ä–∏–≤–∞, –∫–æ–≥–∞—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏—è—Ç `shared_ptr` –∏–∑—á–µ–∑–Ω–µ (–∫–æ–≥–∞—Ç–æ –±—Ä–æ—è—á–∞ —Å—Ç–∞–Ω–µ 0)

---
### –°–∏–Ω—Ç–∞–∫—Å–∏—Å - –ü—Ä–∏–º–µ—Ä

```cpp
#include <iostream>
#include <memory>

class A {
public:
    A(int x, int y) { std::cout << "A(" << x << "," << y << ")
"; }
    void f() { std::cout << "A::f()
"; }
};

int main() {
    std::shared_ptr<A> sp = std::make_shared<A>(2, 3);
    std::shared_ptr<A> sp2 = sp;
    std::shared_ptr<A> sp3 = sp;

    sp2.reset();
    sp3.reset();

    sp->f(); // –í–∏–∫–∞ –º–µ—Ç–æ–¥–∞, –∞–∫–æ –æ–±–µ–∫—Ç—ä—Ç –æ—â–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
}
```

–†–µ–∞–ª–∏–∑–∏—Ä–∞ —Å–µ —Å:
`√¨nt* ref`

##  –ö–∞–∫ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `SharedPtr`

### 1. –°—ä–∑–¥–∞–≤–∞–π **—Ç–æ—á–Ω–æ –µ–¥–∏–Ω** `SharedPtr` –æ—Ç —Å—É—Ä–æ–≤ —É–∫–∞–∑–∞—Ç–µ–ª  
```cpp
A* p = new A();           // 1) –∑–∞–¥–µ–ª—è–Ω–µ –Ω–∞ –æ–±–µ–∫—Ç–∞
SharedPtr<A> sp1(p);         // 2) —Å—ä–∑–¥–∞–≤–∞–º–µ –∫–æ–Ω—Ç—Ä–æ–ª–µ–Ω –±–ª–æ–∫ (refCount = 1)
```
### 2. –í—Å–∏—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏ —Å–ø–æ–¥–µ–ª–µ–Ω–∏ —É–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–µ –ø—Ä–∞–≤—è—Ç `—á—Ä–µ–∑ –∫–æ–ø–∏—Ä–∞–Ω–µ`
```c++
SharedPtr<A> sp2 = sp1;      // copy-ctor / operator= ‚Üí refCount —Å—Ç–∞–≤–∞ 2
```
## –í–ê–ñ–ù–û!!!
```c++
–ù–∏–∫–æ–≥–∞ –Ω–µ –∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞–π –≤—Ç–æ—Ä–∏ SharedPtr –æ—Ç —Å—ä—â–∏—è T*!
–¢–æ–≤–∞ —â–µ —Å—ä–∑–¥–∞–¥–µ –Ω–æ–≤ –±—Ä–æ—è—á –∏ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–Ω–µ —â–µ –¥–æ–≤–µ–¥–µ –¥–æ –¥–≤–æ–π–Ω–æ delete.
```
#### –ü—Ä–∏–º–µ—Ä:
```c++
int* p = new int(42);

std::shared_ptr<int> s1(p);   // control-block #1, use_count = 1
std::shared_ptr<int> s2(p);   // control-block #2, use_count = 1  ‚Üê –ì–†–ï–®–ö–ê!

// –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–Ω–µ:
// s1 -> delete p
// s2 -> delete p  (–≤—Ç–æ—Ä–∏ –ø—ä—Ç)  ‚Üí Undefined Behavior.
```
### 3. –ñ–∏–≤–æ—Ç—ä—Ç –Ω–∞ –æ–±–µ–∫—Ç–∞ –ø—Ä–∏–∫–ª—é—á–≤–∞, –∫–æ–≥–∞—Ç–æ –±—Ä–æ—è—á—ä—Ç —Å—Ç–∏–≥–Ω–µ 0
```c++
{               // –≤—ä—Ç—Ä–µ—à–µ–Ω –æ–±—Ö–≤–∞—Ç
    SharedPtr<A> sp3 = sp1;  // refCount = 3
}               // sp3 –∏–∑–ª–∏–∑–∞ –æ—Ç –æ–±—Ö–≤–∞—Ç ‚Üí refCount = 2

// ‚Ä¶ –∫–æ–¥ ‚Ä¶

// –ü—Ä–∏ –∏–∑–ª–∏–∑–∞–Ω–µ –æ—Ç –æ–±—Ö–≤–∞—Ç–∞ –Ω–∞ sp2 –∏ sp1:
// 1) refCount ‚Üí 1, –ø–æ—Å–ª–µ ‚Üí 0
// 2) –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞ —Å–µ –æ–±–µ–∫—Ç—ä—Ç –∏ —Å–∞–º–∏—è—Ç –±—Ä–æ—è—á

```
### 4. –¢–∏–ø–∏—á–Ω–∏ –≥—Ä–µ—à–∫–∏

| –ì—Ä–µ—à–∫–∞                          | –ö–∞–∫–≤–æ —Å—Ç–∞–≤–∞                                                  | –ö–∞–∫ –¥–∞ —è –∏–∑–±–µ–≥–Ω–µ—à                          |
| ------------------------------- | ------------------------------------------------------------ | ------------------------------------------ |
| `A obj; SharedPtr<A> s1(&obj);` | –£–ø—Ä–∞–≤–ª—è–≤–∞—à **stack**-–æ–±–µ–∫—Ç ‚Üí `delete` –Ω–∞ –∞–¥—Ä–µ—Å –æ—Ç —Å—Ç–µ–∫–∞ ‚Üí UB | –ó–∞–¥–µ–ª—è–π —Å–∞–º–æ —Å `new`                       |
| `SharedPtr<A> s2(&*s1);`        | –≤—Ç–æ—Ä–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º –±—Ä–æ—è—á ‚Üí –¥–≤–æ–π–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–Ω–µ                 | `SharedPtr<A> s2 = s1;`                    |
| –ó–∞–±—Ä–∞–≤–µ–Ω `new` –±–µ–∑ `SharedPtr`  | –∏–∑—Ç–∏—á–∞–Ω–µ –Ω–∞ –ø–∞–º–µ—Ç                                            | –í–∏–Ω–∞–≥–∏ –æ–±–≤–∏–≤–∞–π `new` –≤ `SharedPtr` –≤–µ–¥–Ω–∞–≥–∞ |


###  –ó–∞—â–æ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `make_shared` –≤–º–µ—Å—Ç–æ `new`?

```cpp
// –ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ:
std::shared_ptr<A> sp = std::make_shared<A>(2, 3);

// –û—Å—Ç–∞—Ä—è–ª –ü–æ-—Ä–∏—Å–∫–æ–≤ –Ω–∞—á–∏–Ω:
std::shared_ptr<A> sp(new A(2, 3));
```

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | ‚úÖ `std::make_shared`                     | ‚ùå `std::shared_ptr(new T(...))`         |
|-------------------------------|-------------------------------------------|-------------------------------------------|
| **–ë—Ä–æ–π –∞–ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –ø–∞–º–µ—Ç**     | 1 (–æ–±–µ–∫—Ç + –∫–æ–Ω—Ç—Ä–æ–ª–µ–Ω –±–ª–æ–∫ –∑–∞–µ–¥–Ω–æ)        | 2 (–æ—Ç–¥–µ–ª–Ω–∏ malloc-–∏)                      |
| **–ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç**                | –ü–æ-–±—ä—Ä–∑–æ, –ø–æ-–¥–æ–±—ä—Ä –∫–µ—à                   | –ü–æ-–±–∞–≤–Ω–æ                                  |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –ø—Ä–∏ –∏–∑–∫–ª—é—á–µ–Ω–∏—è** | –î–∞ ‚Äì –Ω—è–º–∞ —à–∞–Ω—Å –∑–∞ memory leak            | –ù–µ ‚Äì –≤—ä–∑–º–æ–∂–µ–Ω leak                        |
| **–°–∏–Ω—Ç–∞–∫—Å–∏—Å**                  | –ö—Ä–∞—Ç—ä–∫ –∏ —è—Å–µ–Ω                            | –ü–æ-–¥—ä–ª—ä–≥ –∏ –ø–æ-—Ä–∏—Å–∫–æ–≤                      |
| **Custom deleter**             | –ù–µ –¥–∏—Ä–µ–∫—Ç–Ω–æ                              | –î–∞ ‚Äì –ø–æ–¥–∞–≤–∞ —Å–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞             |

---


#### `shared_ptr` –∏–º–∞ –ø—Ä–µ–¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏ `*` –∏ `->`, –∫–æ–ø–∏—Ä–∞–Ω–µ –∏ –º–µ—Å—Ç–µ–Ω–µ.
- –í—Å–µ–∫–∏ `shared_ptr` —É–≤–µ–ª–∏—á–∞–≤–∞ –≤—ä—Ç—Ä–µ—à–Ω–∏—è –±—Ä–æ—è—á
- `–¢—Ä–∏–µ–Ω–µ`
  - —Ç—Ä–∏–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—è => –Ω–∞–º–∞–ª—è–≤–∞–º–µ –±—Ä–æ—è—á–∞
  - –ø–æ—Å–ª–µ–¥–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª –∏–∑—Ç—Ä–∏–≤–∞ –æ–±–µ–∫—Ç–∞
  - –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª, —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–∑—Ç—Ä–∏–µ –∏ counter-a
- –ë—Ä–æ—è—á—ä—Ç –ù–ï –µ `static`, –∑–∞—â–æ—Ç–æ —â–µ —Å–µ —Å–ø–æ–¥–µ–ª—è –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω–∏ –æ–±–µ–∫—Ç–∏`shared_ptr`
![Shared_Ptr](shared_counter1.png)  

- –ø–∞–∑–∏–º —É–∫–∞–∑–∞—Ç–µ–ª –∫—ä–º –≤—ä–Ω—à–Ω–∞ –ø–∞–º–µ—Ç, –∫–æ—è—Ç–æ –ø–∞–∑–∏ –±—Ä–æ–π–∫–∞—Ç–∞
![Shared_Ptr2](shared_counter2.png)


## 4.  `weak_ptr` ‚Äì —Å–ª–∞–±–∞ (non-owning) –≤—Ä—ä–∑–∫–∞
`weak_ptr` –µ —É–º–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª, –∫–æ–π—Ç–æ **–Ω–µ –ø—Ä–∏—Ç–µ–∂–∞–≤–∞ –æ–±–µ–∫—Ç–∞**, –∞ —Å–∞–º–æ –≥–æ –Ω–∞–±–ª—é–¥–∞–≤–∞.

###  –û—Å–Ω–æ–≤–Ω–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

- –°–æ—á–∏ –∫—ä–º –æ–±–µ–∫—Ç, –º–µ–Ω–∞–∂–∏—Ä–∞–Ω –æ—Ç `shared_ptr`
- –ù–µ —É–≤–µ–ª–∏—á–∞–≤–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏—è –±—Ä–æ—è—á
- –Ω–µ –≤–ª–∏—è–µ –Ω–∞ —Ç—Ä–∏–µ–Ω–µ—Ç–µ –∏ –º–æ–∂–µ –¥–∞ —Å–æ—á–∏ –∫—ä–º –≤–µ—á–µ –∏–∑—Ç—Ä–∏—Ç –æ–±–µ–∫—Ç
- `weak_ptr` —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–ª–∏ –æ–±–µ–∫—Ç—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç
- –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ –∑–∞:
  - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –æ–±–µ–∫—Ç—ä—Ç –æ—â–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞(–∫–∞—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–∞–ª–∏ –¥–∞–¥–µ–Ω–æ –Ω–µ—â–æ –µ –∂–∏–≤–æ –∏–ª–∏ –Ω–µ.)
  - –∏–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ —Ü–∏–∫–ª–∏—á–Ω–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

---

##### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:
–∏–º–∞ –±—Ä–æ—è—á –∑–∞ –±—Ä–æ—è –Ω–∞ `shared_ptr` —Å–æ—á–µ—â–∏ –∫—ä–º –æ–±–µ–∫—Ç–∞ + –±—Ä–æ—è—á –∑–∞ –±—Ä–æ—è –Ω–∞ `weak_ptr` —Å–æ—á–µ—â–∏ –∫—ä–º –æ–±–µ–∫—Ç–∏

**Counter** - –°—ä–¥—ä—Ä–∂–∞—â 2 int —á–∏—Å–ª–∞ –Ω—è–∫—ä–¥–µ –≤ –ø–∞–º–µ—Ç—Ç–∞

![Weak_Ptr](Weak_Ptr.png)

![Shared_Weak2](Shared_Weak.png)

###  –ü—Ä–∏–º–µ—Ä —Å `weak_ptr`

```cpp
#include <memory>
#include <iostream>

int main() {
    std::shared_ptr<int> sp = std::make_shared<int>(42);
    std::weak_ptr<int> wp = sp;

    if (auto locked = wp.lock()) {
        std::cout << "–û–±–µ–∫—Ç—ä—Ç –µ –∂–∏–≤: " << *locked << std::endl;
    } else {
        std::cout << "–û–±–µ–∫—Ç—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç
";
    }
}
```

###  –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ –≤—ä—Ç—Ä–µ—à–Ω–æ?

- –ö–æ–Ω—Ç—Ä–æ–ª–Ω–∏—è—Ç –±–ª–æ–∫ —Å—ä–¥—ä—Ä–∂–∞:
  - `use_count` ‚Üí –±—Ä–æ–π `shared_ptr`
  - `weak_count` ‚Üí –±—Ä–æ–π `weak_ptr`\
    - 1, use_count>=1
    - 0, use_count=0

- `shared_ptr` –æ—Ç–≥–æ–≤–∞—Ä—è –∑–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ `A`  –∞ weak_ptr –æ—Ç–≥–æ–≤–∞—Ä—è –∑–∞ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ `Counter`
- –ö–æ–≥–∞ —Å–µ —Ç—Ä–∏–µ –æ–±–µ–∫—Ç–∞: `use_count = 0`
- –ö–æ–≥–∞ —Å–µ —Ç—Ä–∏–µ –±—Ä–æ—è—á–∞: `weak_count = 0`
- –ö–æ–Ω—Ç—Ä–æ–ª–Ω–∏—è—Ç –±–ª–æ–∫ —Å–µ –∏–∑—Ç—Ä–∏–≤–∞ –ø—Ä–∏: `use_count == 0 && weak_count == 0`

---


![Shared_Weak1](Shared_Weak1.png)


## 5. `PolymorphicPtr<T>` ‚Äì (–Ω–∞—à–∞ '–∏–∑–º–∏—à–ª—å–æ—Ç–∏–Ω–∞', –Ω—è–º–∞ –≥–æ –≤ stl) —Å–æ–±—Å—Ç–≤–µ–Ω–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –ø–æ–ª–∏–º–æ—Ä—Ñ–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª

`PolymorphicPtr<T>` –µ —Å–æ–±—Å—Ç–≤–µ–Ω–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ **—É–º–µ–Ω —É–∫–∞–∑–∞—Ç–µ–ª —Å –ø–æ–ª–∏–º–æ—Ä—Ñ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**, –∫–æ–π—Ç–æ:

- –ü–æ–∑–≤–æ–ª—è–≤–∞ **—Å—Ç–æ–π–Ω–æ—Å—Ç–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ** –Ω–∞ –æ–±–µ–∫—Ç–∏ –æ—Ç –±–∞–∑–æ–≤ —Ç–∏–ø (–Ω–∞–ø—Ä. `Base`) –±–µ–∑ –Ω—É–∂–¥–∞ –æ—Ç `shared_ptr`, `unique_ptr` –∏–ª–∏ `clone()` –∏–∑–≤—ä–Ω –∫–ª–∞—Å–∞.
- **–ò–∑–∏—Å–∫–≤–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–æ –æ–±–µ–∫—Ç–∏—Ç–µ –¥–∞ –ø–æ–¥–¥—ä—Ä–∂–∞—Ç –º–µ—Ç–æ–¥ `clone()`**, –∫–æ–π—Ç–æ –≤—Ä—ä—â–∞ –∫–æ–ø–∏–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è –æ–±–µ–∫—Ç (`T* clone() const`).
- –ú–æ–∂–µ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤ **—Ö–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏** –∫–∞—Ç–æ `Vector<PolymorphicPtr<Base>>`.
- –ó–∞–º–µ—Å—Ç–≤–∞ `Base**` –≤ **—Ö–µ—Ç–µ—Ä–æ–≥–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** —Å—ä—Å `Vector<PolymorphicPtr<Base>>` –∏ –Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –ø–∏—à–µ–º `BIG 6`

---

### üõ†Ô∏è –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

```cpp
template <class T>
class PolymorphicPtr {
    T* data = nullptr;

    void free();                        // –û—Å–≤–æ–±–æ–∂–¥–∞–≤–∞ –æ–±–µ–∫—Ç–∞
    void moveFrom(PolymorphicPtr&&);   // –ü—Ä–µ—Ö–≤—ä—Ä–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç
    void copyFrom(const PolymorphicPtr&); // –ò–∑–ø–æ–ª–∑–≤–∞ clone()

public:
    PolymorphicPtr() = default;
    PolymorphicPtr(T* ptr);                      // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç —Å—É—Ä–æ–≤ —É–∫–∞–∑–∞—Ç–µ–ª
    PolymorphicPtr(const PolymorphicPtr& other); // –ö–æ–ø–∏—Ä–∞—â –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (deep copy)
    PolymorphicPtr(PolymorphicPtr&& other);      // Move –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

    PolymorphicPtr& operator=(const PolymorphicPtr& other); // –ö–æ–ø–∏—Ä–∞—â–æ –ø—Ä–∏—Å–≤–æ—è–≤–∞–Ω–µ
    PolymorphicPtr& operator=(PolymorphicPtr&& other);      // Move –ø—Ä–∏—Å–≤–æ—è–≤–∞–Ω–µ

    T* operator->();               // –¥–æ—Å—Ç—ä–ø –¥–æ —á–ª–µ–Ω-—Ñ—É–Ω–∫—Ü–∏–∏
    const T* operator->() const;

    T& operator*();                // –¥–æ—Å—Ç—ä–ø –¥–æ –æ–±–µ–∫—Ç–∞
    const T& operator*() const;

    T* get();
    const T* get() const;

    void reset(T* ptr);           // –ø–æ–¥–º—è–Ω–∞ –Ω–∞ –æ–±–µ–∫—Ç–∞
    T* release();                 // –æ—Å–≤–æ–±–æ–∂–¥–∞–≤–∞–Ω–µ –Ω–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è

    ~PolymorphicPtr();            // –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä
};
```

---

### –ü—Ä–µ–¥–∏–º—Å—Ç–≤–∞

- –ü–æ–∑–≤–æ–ª—è–≤–∞ **—Å—Ç–æ–π–Ω–æ—Å—Ç–Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –∑–∞ –æ–±–µ–∫—Ç–∏ —Å –≤–∏—Ä—Ç—É–∞–ª–Ω–∏ –º–µ—Ç–æ–¥–∏**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ **–∫–æ–ø–∏—Ä–∞–Ω–µ, –ø—Ä–µ–º–µ—Å—Ç–≤–∞–Ω–µ –∏ —É–Ω–∏—â–æ–∂–∞–≤–∞–Ω–µ**
- –†–∞–±–æ—Ç–∏ —Å **—Ö–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏** (`std::vector<PolymorphicPtr<Base>>`)
- –ü–æ–∑–≤–æ–ª—è–≤–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –æ–±–µ–∫—Ç–∏ —Å **–≤–∏—Ä—Ç—É–∞–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**, –±–µ–∑ `shared_ptr`, `unique_ptr`, `dynamic_cast`, –∏ –±–µ–∑ `new` –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—è –∫–æ–¥

---

### –ü—Ä–∏–º–µ—Ä –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞

```cpp
struct Shape {
    virtual void draw() const = 0;
    virtual Shape* clone() const = 0;
    virtual ~Shape() = default;
};

struct Circle : Shape {
    void draw() const override { std::cout << "Circle\n"; }
    Shape* clone() const override { return new Circle(*this); }
};

struct Square : Shape {
    void draw() const override { std::cout << "Square\n"; }
    Shape* clone() const override { return new Square(*this); }
};

int main() {
    Vector<PolymorphicPtr<Shape>> shapes; // –∑–∞–º–µ—Å—Ç–≤–∞ Shape ** –≤ —Ö–µ—Ç–µ—Ä–æ–≥–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    shapes.emplace_back(new Circle());
    shapes.emplace_back(new Square());

    for (const auto& s : shapes)
        s->draw();
}
```

---

### –ò–∑–∏—Å–∫–≤–∞–Ω–∏—è –∫—ä–º `T` (–±–∞–∑–æ–≤–∏—è –∫–ª–∞—Å)

- –¢—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ **–≤–∏—Ä—Ç—É–∞–ª–µ–Ω –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä**
- –¢—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –ø—É–±–ª–∏—á–µ–Ω –º–µ—Ç–æ–¥:
```cpp
virtual T* clone() const = 0;
```



